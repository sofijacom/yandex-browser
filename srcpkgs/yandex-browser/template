# Template file for 'yandex-browser'
pkgname=yandex-browser
version=24.12.4.1055
revision=1
_channel=stable
archs="x86_64"
hostmakedepends="curl tar xz python3 python3-html2text python3-setuptools"
depends="gtk+3"
short_desc="Attempt at creating a safer, faster, and more stable browser"
maintainer="Sofiya <sofiya@yandex.ru>"
license="custom:yandex"
homepage="https://browser.yandex.ru/"
nostrip=yes
restricted=yes
repository=nonfree

_baseUrl="https://repo.yandex.ru/yandex-browser/deb/pool/main/y/yandex-browser-stable"
_filename="yandex-browser-${_channel}_${version}-1_amd64.deb"
_yandexUrl="${_baseUrl}/${_filename}"
_licenseUrl="https://yandex.ru/legal/browser_agreement"

distfiles="$_yandexUrl"
checksum=ae649ff714b6a1262584a921add2a2082d8181ab1c68a82a9127bc99e064cf4f

do_extract() {
	mkdir -p ${DESTDIR}
	ar x ${XBPS_SRCDISTDIR}/yandex-browser-${version}/${_filename}
}

do_install() {
	tar xf data.tar.xz -C ${DESTDIR}

	# Install the icons
	for size in 16 24 32 48 64 128 256 512; do
		# Create the yandex browser xdg directory
		mkdir -p ${DESTDIR}/usr/share/icons/hicolor/${size}x${size}/apps

		# Copy the yandex browser icon
		mv ${DESTDIR}/opt/yandex/browser/product_logo_${size}.png \
		   ${DESTDIR}/usr/share/icons/hicolor/${size}x${size}/apps/yandex-browser.png
	done

	# Remove the Debian/Ubuntu crontab
	rm -rf ${DESTDIR}/etc
	rm -rf ${DESTDIR}/opt/yandex/browser/cron

altlinux_fetch_ffmpeg() {
  local current_dir=$PWD
  local temp_dir=$(mktemp -d --tmpdir)
  cd $temp_dir
  # TODO(palar): use more versatile method then download with direct link
  wget http://mirror.yandex.ru/altlinux/Sisyphus/x86_64/RPMS.classic/ffmpeg-plugin-browser-128-alt1.x86_64.rpm
  rpm2cpio *.rpm | cpio -i --make-directories --no-absolute-filenames *libffmpeg.so
  find . -name *.so -exec mv {} /opt/yandex/browser/ \;
  cd $current_dir
  rm -fr $temp_dir
}

getOsName() {
    if [ -f "/etc/os-release" ]
    then
        cat "/etc/os-release" | grep "^ID=" | sed "s/ID=//1"
    fi
}

codecInstallationRequired() {
    current_lunux_distro=$( getOsName ) ;

    if [ "$current_lunux_distro" = "ubuntu" ]; then
        echo "no"
    else
        echo "yes"
    fi
}

codecs_required=$( codecInstallationRequired )

# Remove ffmpeg on browser update, because it is not compatible with new Chromium
# version and will cause crashes if we won't rewrite it with newer version.
if [ -f "/opt/yandex/browser/libffmpeg.so" ]; then
  rm "/opt/yandex/browser/libffmpeg.so"
  codecs_required="yes"
fi

if [ -f "/opt/yandex/browser/codecs_checksum" ]; then
  rm "/opt/yandex/browser/codecs_checksum"
  codecs_required="yes"
fi

if [ "$codecs_required" = "yes" ]; then
    # Do not break installation anyway
    /opt/yandex/browser/update_codecs /opt/yandex/browser || true
fi

# This function uses sed to insert the contents of one file into another file,
# after the first line matching a given regular expression. If there is no
# matching line, then the file is unchanged.
insert_after_first_match() {
  # $1: file to update
  # $2: regular expression
  # $3: file to insert
  sed -i -e "1,/$2/ {
    /$2/ r $3
    }" "$1"
}
}

post_install() {
	curl ${_licenseUrl} | html2text >> yandex-browser-eula.md
	vlicense yandex-browser-eula.md
}

